From 61158d1a0affcd6a8b5b365a9e0bd4086bfb16bd Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Thu, 4 Apr 2019 08:09:13 -0400
Subject: [PATCH] ...

---
 coders/xwd.c | 21 ++++++++++-----------
 1 file changed, 10 insertions(+), 11 deletions(-)

Index: imagemagick-6.9.10.23+dfsg/coders/xwd.c
===================================================================
--- imagemagick-6.9.10.23+dfsg.orig/coders/xwd.c	2019-06-12 13:43:34.635362475 -0400
+++ imagemagick-6.9.10.23+dfsg/coders/xwd.c	2019-06-12 13:43:34.631362460 -0400
@@ -481,17 +481,16 @@ static Image *ReadXWDImage(const ImageIn
             for (x=0; x < (ssize_t) image->columns; x++)
             {
               pixel=XGetPixel(ximage,(int) x,(int) y);
-              index=(IndexPacket) ((pixel >> red_shift) & red_mask);
-              if (index < header.ncolors)
-                SetPixelRed(q,ScaleShortToQuantum(colors[(ssize_t) index].red));
-              index=(IndexPacket) ((pixel >> green_shift) & green_mask);
-              if (index < header.ncolors)
-                SetPixelGreen(q,ScaleShortToQuantum(colors[(ssize_t)
-                  index].green));
-              index=(IndexPacket) ((pixel >> blue_shift) & blue_mask);
-              if (index < header.ncolors)
-                SetPixelBlue(q,ScaleShortToQuantum(colors[(ssize_t)
-                  index].blue));
+              index=ConstrainColormapIndex(image,(pixel >> red_shift) &
+                red_mask);
+              SetPixelRed(q,ScaleShortToQuantum(colors[(ssize_t) index].red));
+              index=ConstrainColormapIndex(image,(pixel >> green_shift) &
+                green_mask);
+              SetPixelGreen(q,ScaleShortToQuantum(colors[(ssize_t)
+                index].green));
+              index=ConstrainColormapIndex(image,(pixel >> blue_shift) &
+                blue_mask);
+              SetPixelBlue(q,ScaleShortToQuantum(colors[(ssize_t) index].blue));
               q++;
             }
             if (SyncAuthenticPixels(image,exception) == MagickFalse)

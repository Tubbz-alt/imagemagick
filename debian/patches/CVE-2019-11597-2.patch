From c979b348d64a25a04f12ea7fe7888b2b23f230a7 Mon Sep 17 00:00:00 2001
From: Dirk Lemstra <dirk@lemstra.org>
Date: Sun, 28 Apr 2019 10:41:53 +0200
Subject: [PATCH] Fixed memory leaks reported in ImageMagick/ImageMagick#1555.

---
 coders/pdf.c | 8 ++++----
 coders/ps3.c | 8 ++++----
 2 files changed, 8 insertions(+), 8 deletions(-)

Index: imagemagick-6.9.10.23+dfsg/coders/pdf.c
===================================================================
--- imagemagick-6.9.10.23+dfsg.orig/coders/pdf.c	2019-06-12 13:45:28.175814880 -0400
+++ imagemagick-6.9.10.23+dfsg/coders/pdf.c	2019-06-12 13:45:28.171814864 -0400
@@ -1204,19 +1204,19 @@ static MagickBooleanType Huffman2DEncode
   unsigned char
     *group4;
 
+  group4_image=CloneImage(inject_image,0,0,MagickTrue,&image->exception);
+  if (group4_image == (Image *) NULL)
+    return(MagickFalse);
   status=MagickTrue;
   write_info=CloneImageInfo(image_info);
   (void) CopyMagickString(write_info->filename,"GROUP4:",MaxTextExtent);
   (void) CopyMagickString(write_info->magick,"GROUP4",MaxTextExtent);
-  group4_image=CloneImage(inject_image,0,0,MagickTrue,&image->exception);
-  if (group4_image == (Image *) NULL)
-    return(MagickFalse);
   group4=(unsigned char *) ImageToBlob(write_info,group4_image,&length,
     &image->exception);
   group4_image=DestroyImage(group4_image);
+  write_info=DestroyImageInfo(write_info);
   if (group4 == (unsigned char *) NULL)
     return(MagickFalse);
-  write_info=DestroyImageInfo(write_info);
   if (WriteBlob(image,length,group4) != (ssize_t) length)
     status=MagickFalse;
   group4=(unsigned char *) RelinquishMagickMemory(group4);
Index: imagemagick-6.9.10.23+dfsg/coders/ps3.c
===================================================================
--- imagemagick-6.9.10.23+dfsg.orig/coders/ps3.c	2019-06-12 13:45:28.175814880 -0400
+++ imagemagick-6.9.10.23+dfsg/coders/ps3.c	2019-06-12 13:45:28.171814864 -0400
@@ -219,19 +219,19 @@ static MagickBooleanType Huffman2DEncode
   unsigned char
     *group4;
 
+  group4_image=CloneImage(inject_image,0,0,MagickTrue,&image->exception);
+  if (group4_image == (Image *) NULL)
+    return(MagickFalse);
   status=MagickTrue;
   write_info=CloneImageInfo(image_info);
   (void) CopyMagickString(write_info->filename,"GROUP4:",MaxTextExtent);
   (void) CopyMagickString(write_info->magick,"GROUP4",MaxTextExtent);
-  group4_image=CloneImage(inject_image,0,0,MagickTrue,&image->exception);
-  if (group4_image == (Image *) NULL)
-    return(MagickFalse);
   group4=(unsigned char *) ImageToBlob(write_info,group4_image,&length,
     &image->exception);
   group4_image=DestroyImage(group4_image);
+  write_info=DestroyImageInfo(write_info);
   if (group4 == (unsigned char *) NULL)
     return(MagickFalse);
-  write_info=DestroyImageInfo(write_info);
   if (WriteBlob(image,length,group4) != (ssize_t) length)
     status=MagickFalse;
   group4=(unsigned char *) RelinquishMagickMemory(group4);

From e2a21735e3a3f3930bd431585ec36334c4c2eb77 Mon Sep 17 00:00:00 2001
From: Cristy <mikayla-grace@urban-warrior.org>
Date: Mon, 8 Apr 2019 18:38:04 -0400
Subject: [PATCH] https://github.com/ImageMagick/ImageMagick/issues/1540

---
 magick/quantize.c | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/magick/quantize.c b/magick/quantize.c
index d677e9739..461d83997 100644
--- a/magick/quantize.c
+++ b/magick/quantize.c
@@ -3260,11 +3260,11 @@ static MagickBooleanType SetGrayscaleImage(Image *image)
   if (image->type != GrayscaleType)
     (void) TransformImageColorspace(image,GRAYColorspace);
   if (image->storage_class == PseudoClass)
-    colormap_index=(ssize_t *) AcquireQuantumMemory(image->colors+1,
-      sizeof(*colormap_index));
+    colormap_index=(ssize_t *) AcquireQuantumMemory(MagickMax(image->colors+1,
+      MaxMap),sizeof(*colormap_index));
   else
-    colormap_index=(ssize_t *) AcquireQuantumMemory(MaxColormapSize+1,
-      sizeof(*colormap_index));
+    colormap_index=(ssize_t *) AcquireQuantumMemory(MagickMax(MaxColormapSize+1,
+      MaxMap),sizeof(*colormap_index));
   if (colormap_index == (ssize_t *) NULL)
     ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
       image->filename);
